# Data Model: RAG Agent using OpenAI Agent SDK

## Overview
Data structures for the RAG agent system that integrates OpenAI Agent SDK with Qdrant-based retrieval.

## Core Entities

### AgentQuery
**Description**: Input query submitted to the RAG agent for processing
- `query_text`: String - Natural language question or query from user
- `user_selected_text`: String (optional) - Additional context provided by user
- `timestamp`: DateTime - When the query was submitted
- `request_id`: String - Unique identifier for tracking the request

### RetrievedContext
**Description**: Context retrieved from Qdrant based on semantic similarity to the query
- `chunks`: List[RetrievedChunk] - Relevant text chunks with metadata
- `query_embedding`: List[float] - Vector representation of the query
- `retrieval_time`: Float - Time taken to retrieve context in seconds
- `total_chunks_found`: Integer - Total number of chunks found before filtering

### RetrievedChunk
**Description**: Individual text chunk retrieved from the Qdrant collection
- `text`: String - The actual content of the chunk
- `source_url`: String - URL where the content originated
- `position`: Integer - Position of chunk in original document
- `score`: Float - Semantic similarity score (0.0-1.0)
- `chunk_id`: String - Unique identifier for the chunk
- `created_at`: Float - Timestamp when chunk was indexed

### GroundedResponse
**Description**: Response generated by the agent that is grounded in retrieved context
- `answer`: String - The final answer generated by the agent
- `confidence_score`: Float - Confidence level in the response quality
- `sources_used`: List[String] - List of source URLs used in the response
- `processing_time`: Float - Total time taken to generate response
- `grounding_validation_passed`: Boolean - Whether response passed grounding checks

### AgentToolCall
**Description**: Record of tools called by the agent during response generation
- `tool_name`: String - Name of the tool called (e.g., "retrieval_tool")
- `input_parameters`: Dict - Parameters passed to the tool
- `result`: Any - Result returned by the tool
- `execution_time`: Float - Time taken to execute the tool call

## Relationships

### AgentQuery -> RetrievedContext
- One-to-many relationship
- A single query triggers retrieval of multiple context chunks
- Context is filtered and ranked before being used for response generation

### RetrievedContext -> RetrievedChunk
- One-to-many relationship
- Retrieved context consists of multiple individual chunks
- Each chunk maintains its metadata for proper attribution

### RetrievedContext -> GroundedResponse
- One-to-one relationship
- Retrieved context is used as input to generate a single grounded response
- Response generation validates that content comes only from retrieved context

### AgentQuery -> AgentToolCall
- One-to-many relationship
- A single query may trigger multiple tool calls during agent execution
- Tool calls are recorded for debugging and monitoring purposes

## Validation Rules

### AgentQuery Validation
- `query_text` must not be empty or only whitespace
- `query_text` length should be within reasonable limits (e.g., 1-1000 characters)
- `user_selected_text` (if provided) should not exceed token limits

### RetrievedChunk Validation
- `text` field must not be empty
- `score` must be between 0.0 and 1.0
- `source_url` must be a valid URL format
- `position` must be a non-negative integer

### GroundedResponse Validation
- `answer` must contain information only from retrieved context
- `sources_used` must correspond to actual retrieved chunks
- `confidence_score` must be between 0.0 and 1.0
- Response must pass hallucination detection validation

## State Transitions

### AgentQuery Lifecycle
1. **Submitted** - Query received by the agent system
2. **Processing** - Agent retrieves context and generates response
3. **Completed** - Response generated with proper citations
4. **Delivered** - Response returned to the user

### RetrievedContext Lifecycle
1. **Requested** - Agent initiates retrieval based on query
2. **Retrieved** - Chunks fetched from Qdrant with metadata
3. **Filtered** - Irrelevant or low-scoring chunks removed
4. **Validated** - Context checked for quality and relevance
5. **Ready for Use** - Context passed to response generation

## Serialization Formats

### JSON Schema for AgentQuery
```json
{
  "query_text": "string",
  "user_selected_text": "string | null",
  "timestamp": "ISO8601 datetime",
  "request_id": "string"
}
```

### JSON Schema for GroundedResponse
```json
{
  "answer": "string",
  "confidence_score": "float",
  "sources_used": "string[]",
  "processing_time": "float",
  "grounding_validation_passed": "boolean"
}
```